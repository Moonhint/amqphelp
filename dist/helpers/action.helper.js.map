{"version":3,"sources":["../../app/helpers/action.helper.js"],"names":["MessagingAction","constructor","settings","utils","MessagingChannel","successful_rpc","ping_count","retry_rpc","stringify_payload","ping","ping_message","ping_interval","self","channel","create","connection","host","options","user","pass","queue_name","process","env","npm_package_name","assertQueue","interval","setInterval","the_queue","sendToQueue","Buffer","NODE_ENV","console","log","send","queue_message","undefined","Error","create_task","payload","durable","persistent","JSON","stringify","queue_worker","prefetch","consume","msg","ch","ack","noAck","rpc_client","correlationId","response_activity","q","exclusive","queue","properties","replyTo","rpc_server","activity","reply","receive","callback","TypeError","parse","content","toString","subscribe","info"],"mappings":"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","file":"action.helper.js","sourcesContent":["export class MessagingAction {\r\n\r\n  // Depedency Injection:\r\n  constructor({ settings, utils, MessagingChannel, successful_rpc } = {}) {\r\n    // a service for handling AMQP channel creation\r\n    this.MessagingChannel = MessagingChannel;\r\n\r\n    // configuration settings\r\n    this.settings = settings;\r\n\r\n    // messaging utilities function helper\r\n    this.utils = utils || null;\r\n\r\n    // other tracked parameters\r\n    this.ping_count = 0;\r\n    this.retry_rpc = 0;\r\n    this.successful_rpc = successful_rpc || false;\r\n    this.stringify_payload;\r\n  }\r\n\r\n  async ping(ping_message, ping_interval=3000){\r\n    let self = this;\r\n\r\n    let channel = await this.MessagingChannel.create(\r\n      this.settings.connection.host,\r\n      this.settings.connection.options.user,\r\n      this.settings.connection.options.pass\r\n    );\r\n\r\n    let queue_name = `${process.env.npm_package_name}_heartbeat`;\r\n\r\n    await channel.assertQueue(queue_name);\r\n\r\n    let interval = setInterval(async function () {\r\n      let the_queue = channel.sendToQueue(queue_name, new Buffer(`${ping_message} ${self.ping_count}`));\r\n\r\n      if (process.env.NODE_ENV !== \"test\") console.log(`[o] Sent '${ping_message} ${self.ping_count}'`);\r\n\r\n      self.ping_count++;\r\n    }, ping_interval);\r\n\r\n    return interval;\r\n  }\r\n\r\n\r\n  async send(queue_name, queue_message){\r\n\r\n    if(queue_name === undefined || queue_message === undefined){\r\n      throw new Error('Queue name and queue message is undefined')\r\n    }\r\n\r\n    let self = this;\r\n\r\n    let channel = await this.MessagingChannel.create(\r\n      this.settings.connection.host,\r\n      this.settings.connection.options.user,\r\n      this.settings.connection.options.pass\r\n    );\r\n\r\n    await channel.assertQueue(queue_name);\r\n\r\n    let the_queue = channel.sendToQueue(queue_name, new Buffer(`${queue_message}`));\r\n\r\n    if (process.env.NODE_ENV !== \"test\") console.log(`[o] Sent '${queue_message}'`);\r\n\r\n    return true;\r\n  }\r\n\r\n  async create_task(queue_name=null, payload=null, durable=true, persistent=true){\r\n\r\n    if(queue_name===null || payload===null){\r\n      throw new Error('Queue name and payload is required, as first and second params');\r\n    }\r\n\r\n    let self = this;\r\n    let channel = await this.MessagingChannel.create(\r\n      this.settings.connection.host,\r\n      this.settings.connection.options.user,\r\n      this.settings.connection.options.pass\r\n    );\r\n\r\n    await channel.assertQueue(queue_name, {durable: durable});\r\n\r\n    this.stringify_payload = JSON.stringify(payload);\r\n\r\n    let the_queue = channel.sendToQueue(queue_name, new Buffer(this.stringify_payload), {persistent: persistent});\r\n  }\r\n\r\n  async queue_worker(queue_name=null, prefetch=3, durable=true){\r\n\r\n    if(queue_name===null){\r\n      throw new Error('Queue name is required, as the first params');\r\n    }\r\n\r\n    let self = this;\r\n    let channel = await this.MessagingChannel.create(\r\n      this.settings.connection.host,\r\n      this.settings.connection.options.user,\r\n      this.settings.connection.options.pass\r\n    );\r\n\r\n    await channel.assertQueue(queue_name, {durable: durable});\r\n\r\n    channel.prefetch(prefetch);\r\n\r\n    channel.consume(queue_name, function(msg) {\r\n      if (msg !== null) {\r\n        // events[queue_name](msg.content);\r\n        ch.ack(msg);\r\n      }\r\n    }, {noAck: false});\r\n  }\r\n\r\n  async rpc_client(queue_name=null, payload=null, correlationId=null, response_activity=null){\r\n\r\n    if(queue_name===null || payload===null){\r\n      throw new Error('Queue name and payload is required, as first and second params');\r\n    }\r\n\r\n    if(correlationId===null || response_activity===null){\r\n      throw new Error('correlationId and response_activity is required, as third and fourth params');\r\n    }\r\n\r\n    let self = this;\r\n\r\n    let channel = await self.MessagingChannel.create(\r\n      this.settings.connection.host,\r\n      this.settings.connection.options.user,\r\n      this.settings.connection.options.pass\r\n    );\r\n\r\n    let q = await channel.assertQueue('', {exclusive: true});\r\n\r\n    channel.consume(q.queue, async function(msg) {\r\n      if (msg.properties.correlationId === correlationId) {\r\n        await response_activity(msg, channel);\r\n        self.successful_rpc = true;\r\n      }\r\n    }, {noAck: true});\r\n\r\n    self.stringify_payload = JSON.stringify(payload);\r\n\r\n    let the_queue = channel.sendToQueue(queue_name, new Buffer(self.stringify_payload),\r\n                                                    { correlationId: correlationId, replyTo: q.queue });\r\n\r\n  }\r\n\r\n  async rpc_server(queue_name=null, activity=null, prefetch=3){\r\n    if(queue_name===null || activity===null){\r\n      throw new Error('Queue name and activity is required, as the first and second params');\r\n    }\r\n\r\n    let self = this;\r\n    let channel = await this.MessagingChannel.create(\r\n      this.settings.connection.host,\r\n      this.settings.connection.options.user,\r\n      this.settings.connection.options.pass\r\n    );\r\n\r\n    await channel.assertQueue(queue_name, {durable: false});\r\n\r\n    channel.prefetch(prefetch);\r\n\r\n    channel.consume(queue_name, async function reply(msg) {\r\n      await activity(msg, channel);\r\n    });\r\n\r\n  }\r\n\r\n  async receive(queue_name, callback){\r\n    if(!queue_name || !callback){\r\n      throw new TypeError()\r\n    }\r\n    let self = this;\r\n\r\n    let channel = await this.MessagingChannel.create(\r\n      this.settings.connection.host,\r\n      this.settings.connection.options.user,\r\n      this.settings.connection.options.pass\r\n    );\r\n\r\n    await channel.assertQueue(queue_name);\r\n    channel.consume(queue_name, function(msg) {\r\n      if (msg !== null) {\r\n        channel.ack(msg);\r\n        callback(JSON.parse(msg.content.toString()));\r\n      }    \r\n    });\r\n\r\n  }\r\n\r\n  //DEPRECATED: renamed to receive\r\n  async subscribe(queue_name, callback){\r\n    let self = this;\r\n\r\n    let channel = await this.MessagingChannel.create(\r\n      this.settings.connection.host,\r\n      this.settings.connection.options.user,\r\n      this.settings.connection.options.pass\r\n    );\r\n\r\n    await channel.assertQueue(queue_name);\r\n    channel.consume(queue_name, function(msg) {\r\n      if (msg !== null) {\r\n        console.info(msg.content.toString());\r\n        // events[queue_name](msg.content);\r\n        channel.ack(msg);\r\n        callback(msg);\r\n      }\r\n    });\r\n\r\n  }\r\n\r\n};\r\n"]}